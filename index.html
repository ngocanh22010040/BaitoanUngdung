<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quản lý dữ liệu cảm biến IoT</title>
<style>
  body { max-width: 600px; margin: 20px auto; font-family: Arial, sans-serif; }
  input, button { width: 100%; padding: 8px; margin: 6px 0; box-sizing: border-box; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  th { background-color: #f2f2f2; }
  .status { margin-top: 10px; }
</style>
</head>
<body>

<h1>Quản lý dữ liệu cảm biến IoT</h1>

<div>
  <h3>Gửi dữ liệu cảm biến</h3>
  <input id="sensor_id" type="text" placeholder="Sensor ID (UUID)" />
  <input id="temperature" type="number" step="0.01" placeholder="Nhiệt độ (°C)" />
  <input id="humidity" type="number" step="0.01" placeholder="Độ ẩm (%)" />
  <button id="sendBtn">Gửi dữ liệu</button>
  <div class="status" id="status"></div>
</div>

<div>
  <h3>Danh sách dữ liệu cảm biến</h3>
  <table>
    <thead>
      <tr>
        <th>Sensor ID</th>
        <th>Timestamp</th>
        <th>Nhiệt độ (°C)</th>
        <th>Độ ẩm (%)</th>
      </tr>
    </thead>
    <tbody id="dataTableBody">
      <tr><td colspan="4">Chưa có dữ liệu</td></tr>
    </tbody>
  </table>
</div>

<script>
  const apiBase = "http://localhost:8000";

  const statusDiv = document.getElementById("status");
  const dataTableBody = document.getElementById("dataTableBody");

  document.getElementById("sendBtn").addEventListener("click", async () => {
    const sensor_id = document.getElementById("sensor_id").value.trim();
    const temperature = parseFloat(document.getElementById("temperature").value);
    const humidity = parseFloat(document.getElementById("humidity").value);

    if (!sensor_id || isNaN(temperature) || isNaN(humidity)) {
      statusDiv.textContent = "Vui lòng nhập đầy đủ và đúng định dạng.";
      return;
    }

    statusDiv.textContent = "Đang gửi dữ liệu...";

    try {
      const res = await fetch(apiBase + "/data", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sensor_id, temperature, humidity }),
      });

      if (res.ok) {
        statusDiv.textContent = "Gửi dữ liệu thành công!";
        document.getElementById("sensor_id").value = "";
        document.getElementById("temperature").value = "";
        document.getElementById("humidity").value = "";
        loadData();
      } else {
        statusDiv.textContent = "Lỗi khi gửi dữ liệu.";
      }
    } catch (err) {
      statusDiv.textContent = "Lỗi kết nối API.";
    }
  });

  async function loadData() {
    try {
      const res = await fetch(apiBase + "/data");
      if (!res.ok) throw new Error("Không thể lấy dữ liệu");
      const data = await res.json();

      if (!data.length) {
        dataTableBody.innerHTML = "<tr><td colspan='4'>Chưa có dữ liệu</td></tr>";
        return;
      }

      dataTableBody.innerHTML = "";
      data.forEach((item) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.sensor_id}</td>
          <td>${new Date(item.timestamp).toLocaleString()}</td>
          <td>${item.temperature}</td>
          <td>${item.humidity}</td>
        `;
        dataTableBody.appendChild(tr);
      });
    } catch {
      dataTableBody.innerHTML = "<tr><td colspan='4'>Lỗi tải dữ liệu</td></tr>";
    }
  }

  // Load dữ liệu khi mở trang
  loadData();
</script>

</body>
</html>
